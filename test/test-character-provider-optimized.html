<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CharacterProvider 优化测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .performance-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .search-demo {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
            margin: 5px;
        }
        .search-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">🚀 CharacterProvider 性能优化测试</h1>
        
        <div class="test-section">
            <h3>索引性能测试</h3>
            <button onclick="testIndexPerformance()">测试索引性能</button>
            <div id="index-results"></div>
        </div>

        <div class="test-section">
            <h3>查询优化测试</h3>
            <button onclick="testQueryOptimization()">测试查询优化</button>
            <div id="query-results"></div>
        </div>

        <div class="test-section">
            <h3>代码简化测试</h3>
            <button onclick="testCodeSimplification()">测试重复逻辑提取</button>
            <div id="simplification-results"></div>
        </div>

        <div class="test-section">
            <h3>搜索功能演示</h3>
            <div class="search-demo">
                <h4>实时搜索演示（带防抖）</h4>
                <input type="text" id="search-input" placeholder="输入汉字或拼音搜索...">
                <div class="search-results" id="search-results">搜索结果将显示在这里...</div>
            </div>
            <button onclick="testSearchFeatures()">测试搜索功能</button>
            <div id="search-results-test"></div>
        </div>

        <div class="test-section">
            <h3>新增功能测试</h3>
            <button onclick="testNewFeatures()">测试新增功能</button>
            <div id="new-features-results"></div>
        </div>

        <div class="test-section">
            <h3>完整性能基准测试</h3>
            <button onclick="runPerformanceBenchmark()">运行性能基准测试</button>
            <div id="benchmark-results"></div>
        </div>
    </div>

    <!-- 引入优化后的 CharacterProvider -->
    <script src="character-provider.js"></script>

    <script>
        let characterProvider = null;
        let debouncedSearch = null;

        // 工具函数
        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // 初始化
        async function initializeProvider() {
            if (!characterProvider) {
                characterProvider = new CharacterProvider();
                await characterProvider.load();
                
                // 创建防抖搜索函数
                debouncedSearch = SearchUtils.createDebouncedSearch(characterProvider, 300);
            }
            return characterProvider;
        }

        // 测试索引性能
        async function testIndexPerformance() {
            clearResults('index-results');
            
            try {
                const provider = await initializeProvider();
                
                // 获取索引统计
                const indexStats = provider.getIndexStatistics();
                logResult('index-results', 
                    `<div class="performance-stats">
                        <h4>📊 索引统计信息</h4>
                        <p>汉字索引大小: ${indexStats.characterMapSize}</p>
                        <p>拼音索引大小: ${indexStats.pinyinMapSize}</p>
                        <p>索引状态: ${indexStats.isIndexed ? '✅ 已建立' : '❌ 未建立'}</p>
                    </div>`, 'info');

                // 性能对比测试
                const testChars = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
                
                // 测试索引查询性能
                const startTime = performance.now();
                for (let i = 0; i < 1000; i++) {
                    for (const char of testChars) {
                        await provider.getCharacterInfo(char);
                    }
                }
                const endTime = performance.now();
                
                logResult('index-results', 
                    `⚡ 索引查询性能: 10,000次查询耗时 ${(endTime - startTime).toFixed(2)}ms`, 
                    'success');
                
            } catch (error) {
                logResult('index-results', `❌ 索引性能测试失败: ${error.message}`, 'error');
            }
        }

        // 测试查询优化
        async function testQueryOptimization() {
            clearResults('query-results');
            
            try {
                const provider = await initializeProvider();
                
                // 测试精确查询
                const char = await provider.getCharacterInfo('一');
                if (char) {
                    logResult('query-results', 
                        `✅ 精确查询成功: ${char.char} (${char.pinyin}) - 排名: ${char.rank}`, 
                        'success');
                }
                
                // 测试批量查询
                const chars = await provider.getCharactersInfo(['一', '二', '三']);
                logResult('query-results', 
                    `✅ 批量查询成功: 获取到 ${chars.length} 个汉字信息`, 
                    'success');
                
                // 测试拼音查询
                const pinyinResults = await provider.getCharactersByPinyin('yī');
                logResult('query-results', 
                    `✅ 拼音查询成功: "yī" 对应 ${pinyinResults.length} 个汉字`, 
                    'success');
                
            } catch (error) {
                logResult('query-results', `❌ 查询优化测试失败: ${error.message}`, 'error');
            }
        }

        // 测试代码简化
        async function testCodeSimplification() {
            clearResults('simplification-results');
            
            try {
                const provider = await initializeProvider();
                const learnedChars = new Set(['一', '二', '三']);
                
                // 测试各种方法是否正确使用了提取的逻辑
                const highFreq = await provider.getNextHighFrequencyCharacters(learnedChars, 5);
                logResult('simplification-results', 
                    `✅ 高频汉字查询: 获取到 ${highFreq.length} 个未学习汉字`, 
                    'success');
                
                const random = await provider.getRandomCharacters(5, learnedChars);
                logResult('simplification-results', 
                    `✅ 随机汉字查询: 获取到 ${random.length} 个未学习汉字`, 
                    'success');
                
                const rankRange = await provider.getCharactersByRankRange(1, 10, learnedChars);
                logResult('simplification-results', 
                    `✅ 排名范围查询: 获取到 ${rankRange.length} 个未学习汉字`, 
                    'success');
                
                // 验证过滤逻辑
                const hasLearned = highFreq.some(char => learnedChars.has(char.char));
                if (!hasLearned) {
                    logResult('simplification-results', 
                        '✅ 过滤逻辑正确: 所有结果都是未学习汉字', 
                        'success');
                } else {
                    logResult('simplification-results', 
                        '❌ 过滤逻辑错误: 结果中包含已学习汉字', 
                        'error');
                }
                
            } catch (error) {
                logResult('simplification-results', `❌ 代码简化测试失败: ${error.message}`, 'error');
            }
        }

        // 测试搜索功能
        async function testSearchFeatures() {
            clearResults('search-results-test');
            
            try {
                const provider = await initializeProvider();
                
                // 测试精确汉字搜索
                const exactChar = await provider.searchCharacters('一');
                logResult('search-results-test', 
                    `✅ 精确汉字搜索: "一" 找到 ${exactChar.length} 个结果`, 
                    'success');
                
                // 测试精确拼音搜索
                const exactPinyin = await provider.searchCharacters('yī');
                logResult('search-results-test', 
                    `✅ 精确拼音搜索: "yī" 找到 ${exactPinyin.length} 个结果`, 
                    'success');
                
                // 测试模糊搜索
                const fuzzy = await provider.searchCharacters('zh');
                logResult('search-results-test', 
                    `✅ 模糊搜索: "zh" 找到 ${fuzzy.length} 个结果`, 
                    'success');
                
                // 测试空查询
                const empty = await provider.searchCharacters('');
                logResult('search-results-test', 
                    `✅ 空查询处理: 返回 ${empty.length} 个结果`, 
                    empty.length === 0 ? 'success' : 'warning');
                
            } catch (error) {
                logResult('search-results-test', `❌ 搜索功能测试失败: ${error.message}`, 'error');
            }
        }

        // 测试新增功能
        async function testNewFeatures() {
            clearResults('new-features-results');
            
            try {
                const provider = await initializeProvider();
                
                // 测试批量获取汉字信息
                const batchInfo = await provider.getCharactersInfo(['一', '二', '三', '不存在']);
                logResult('new-features-results', 
                    `✅ 批量获取汉字信息: 请求4个，获取到 ${batchInfo.length} 个`, 
                    'success');
                
                // 测试根据拼音获取汉字
                const pinyinChars = await provider.getCharactersByPinyin('zhī');
                logResult('new-features-results', 
                    `✅ 根据拼音获取汉字: "zhī" 对应 ${pinyinChars.length} 个汉字`, 
                    'success');
                
                // 测试索引统计
                const stats = provider.getIndexStatistics();
                logResult('new-features-results', 
                    `✅ 索引统计: 汉字索引${stats.characterMapSize}个，拼音索引${stats.pinyinMapSize}个`, 
                    'success');
                
            } catch (error) {
                logResult('new-features-results', `❌ 新增功能测试失败: ${error.message}`, 'error');
            }
        }

        // 运行性能基准测试
        async function runPerformanceBenchmark() {
            clearResults('benchmark-results');
            
            try {
                const provider = await initializeProvider();
                logResult('benchmark-results', '🚀 开始性能基准测试...', 'info');
                
                // 测试1: 单次查询性能
                const singleStart = performance.now();
                await provider.getCharacterInfo('一');
                const singleEnd = performance.now();
                
                logResult('benchmark-results', 
                    `📊 单次索引查询: ${(singleEnd - singleStart).toFixed(3)}ms`, 
                    'info');
                
                // 测试2: 批量查询性能
                const batchStart = performance.now();
                const testChars = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
                await provider.getCharactersInfo(testChars);
                const batchEnd = performance.now();
                
                logResult('benchmark-results', 
                    `📊 批量查询(10个): ${(batchEnd - batchStart).toFixed(3)}ms`, 
                    'info');
                
                // 测试3: 搜索性能
                const searchStart = performance.now();
                await provider.searchCharacters('zh');
                const searchEnd = performance.now();
                
                logResult('benchmark-results', 
                    `📊 模糊搜索性能: ${(searchEnd - searchStart).toFixed(3)}ms`, 
                    'info');
                
                logResult('benchmark-results', '🎉 性能基准测试完成！', 'success');
                
            } catch (error) {
                logResult('benchmark-results', `❌ 性能基准测试失败: ${error.message}`, 'error');
            }
        }

        // 实时搜索演示
        function setupSearchDemo() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            
            if (searchInput && debouncedSearch) {
                searchInput.addEventListener('input', async (event) => {
                    const query = event.target.value;
                    
                    if (query.trim() === '') {
                        searchResults.innerHTML = '搜索结果将显示在这里...';
                        return;
                    }
                    
                    searchResults.innerHTML = '🔍 搜索中...';
                    
                    try {
                        const results = await debouncedSearch(query, new Set());
                        
                        if (results.length === 0) {
                            searchResults.innerHTML = '😔 没有找到匹配的汉字';
                        } else {
                            searchResults.innerHTML = results.slice(0, 10).map(char => 
                                `<div style="margin: 5px 0; padding: 5px; border: 1px solid #eee; border-radius: 3px;">
                                    <strong>${char.char}</strong> - ${char.pinyin} (排名: ${char.rank})
                                </div>`
                            ).join('');
                        }
                    } catch (error) {
                        searchResults.innerHTML = `❌ 搜索错误: ${error.message}`;
                    }
                });
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', async () => {
            console.log('🚀 CharacterProvider 优化测试页面已加载');
            
            try {
                await initializeProvider();
                setupSearchDemo();
                console.log('✅ 初始化完成');
            } catch (error) {
                console.error('❌ 初始化失败:', error);
            }
        });
    </script>
</body>
</html>
