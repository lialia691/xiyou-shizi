<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CharacterProvider ä¼˜åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .performance-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .search-demo {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
            margin: 5px;
        }
        .search-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">ğŸš€ CharacterProvider æ€§èƒ½ä¼˜åŒ–æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ç´¢å¼•æ€§èƒ½æµ‹è¯•</h3>
            <button onclick="testIndexPerformance()">æµ‹è¯•ç´¢å¼•æ€§èƒ½</button>
            <div id="index-results"></div>
        </div>

        <div class="test-section">
            <h3>æŸ¥è¯¢ä¼˜åŒ–æµ‹è¯•</h3>
            <button onclick="testQueryOptimization()">æµ‹è¯•æŸ¥è¯¢ä¼˜åŒ–</button>
            <div id="query-results"></div>
        </div>

        <div class="test-section">
            <h3>ä»£ç ç®€åŒ–æµ‹è¯•</h3>
            <button onclick="testCodeSimplification()">æµ‹è¯•é‡å¤é€»è¾‘æå–</button>
            <div id="simplification-results"></div>
        </div>

        <div class="test-section">
            <h3>æœç´¢åŠŸèƒ½æ¼”ç¤º</h3>
            <div class="search-demo">
                <h4>å®æ—¶æœç´¢æ¼”ç¤ºï¼ˆå¸¦é˜²æŠ–ï¼‰</h4>
                <input type="text" id="search-input" placeholder="è¾“å…¥æ±‰å­—æˆ–æ‹¼éŸ³æœç´¢...">
                <div class="search-results" id="search-results">æœç´¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
            <button onclick="testSearchFeatures()">æµ‹è¯•æœç´¢åŠŸèƒ½</button>
            <div id="search-results-test"></div>
        </div>

        <div class="test-section">
            <h3>æ–°å¢åŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testNewFeatures()">æµ‹è¯•æ–°å¢åŠŸèƒ½</button>
            <div id="new-features-results"></div>
        </div>

        <div class="test-section">
            <h3>å®Œæ•´æ€§èƒ½åŸºå‡†æµ‹è¯•</h3>
            <button onclick="runPerformanceBenchmark()">è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•</button>
            <div id="benchmark-results"></div>
        </div>
    </div>

    <!-- å¼•å…¥ä¼˜åŒ–åçš„ CharacterProvider -->
    <script src="character-provider.js"></script>

    <script>
        let characterProvider = null;
        let debouncedSearch = null;

        // å·¥å…·å‡½æ•°
        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // åˆå§‹åŒ–
        async function initializeProvider() {
            if (!characterProvider) {
                characterProvider = new CharacterProvider();
                await characterProvider.load();
                
                // åˆ›å»ºé˜²æŠ–æœç´¢å‡½æ•°
                debouncedSearch = SearchUtils.createDebouncedSearch(characterProvider, 300);
            }
            return characterProvider;
        }

        // æµ‹è¯•ç´¢å¼•æ€§èƒ½
        async function testIndexPerformance() {
            clearResults('index-results');
            
            try {
                const provider = await initializeProvider();
                
                // è·å–ç´¢å¼•ç»Ÿè®¡
                const indexStats = provider.getIndexStatistics();
                logResult('index-results', 
                    `<div class="performance-stats">
                        <h4>ğŸ“Š ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯</h4>
                        <p>æ±‰å­—ç´¢å¼•å¤§å°: ${indexStats.characterMapSize}</p>
                        <p>æ‹¼éŸ³ç´¢å¼•å¤§å°: ${indexStats.pinyinMapSize}</p>
                        <p>ç´¢å¼•çŠ¶æ€: ${indexStats.isIndexed ? 'âœ… å·²å»ºç«‹' : 'âŒ æœªå»ºç«‹'}</p>
                    </div>`, 'info');

                // æ€§èƒ½å¯¹æ¯”æµ‹è¯•
                const testChars = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
                
                // æµ‹è¯•ç´¢å¼•æŸ¥è¯¢æ€§èƒ½
                const startTime = performance.now();
                for (let i = 0; i < 1000; i++) {
                    for (const char of testChars) {
                        await provider.getCharacterInfo(char);
                    }
                }
                const endTime = performance.now();
                
                logResult('index-results', 
                    `âš¡ ç´¢å¼•æŸ¥è¯¢æ€§èƒ½: 10,000æ¬¡æŸ¥è¯¢è€—æ—¶ ${(endTime - startTime).toFixed(2)}ms`, 
                    'success');
                
            } catch (error) {
                logResult('index-results', `âŒ ç´¢å¼•æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æŸ¥è¯¢ä¼˜åŒ–
        async function testQueryOptimization() {
            clearResults('query-results');
            
            try {
                const provider = await initializeProvider();
                
                // æµ‹è¯•ç²¾ç¡®æŸ¥è¯¢
                const char = await provider.getCharacterInfo('ä¸€');
                if (char) {
                    logResult('query-results', 
                        `âœ… ç²¾ç¡®æŸ¥è¯¢æˆåŠŸ: ${char.char} (${char.pinyin}) - æ’å: ${char.rank}`, 
                        'success');
                }
                
                // æµ‹è¯•æ‰¹é‡æŸ¥è¯¢
                const chars = await provider.getCharactersInfo(['ä¸€', 'äºŒ', 'ä¸‰']);
                logResult('query-results', 
                    `âœ… æ‰¹é‡æŸ¥è¯¢æˆåŠŸ: è·å–åˆ° ${chars.length} ä¸ªæ±‰å­—ä¿¡æ¯`, 
                    'success');
                
                // æµ‹è¯•æ‹¼éŸ³æŸ¥è¯¢
                const pinyinResults = await provider.getCharactersByPinyin('yÄ«');
                logResult('query-results', 
                    `âœ… æ‹¼éŸ³æŸ¥è¯¢æˆåŠŸ: "yÄ«" å¯¹åº” ${pinyinResults.length} ä¸ªæ±‰å­—`, 
                    'success');
                
            } catch (error) {
                logResult('query-results', `âŒ æŸ¥è¯¢ä¼˜åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ä»£ç ç®€åŒ–
        async function testCodeSimplification() {
            clearResults('simplification-results');
            
            try {
                const provider = await initializeProvider();
                const learnedChars = new Set(['ä¸€', 'äºŒ', 'ä¸‰']);
                
                // æµ‹è¯•å„ç§æ–¹æ³•æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº†æå–çš„é€»è¾‘
                const highFreq = await provider.getNextHighFrequencyCharacters(learnedChars, 5);
                logResult('simplification-results', 
                    `âœ… é«˜é¢‘æ±‰å­—æŸ¥è¯¢: è·å–åˆ° ${highFreq.length} ä¸ªæœªå­¦ä¹ æ±‰å­—`, 
                    'success');
                
                const random = await provider.getRandomCharacters(5, learnedChars);
                logResult('simplification-results', 
                    `âœ… éšæœºæ±‰å­—æŸ¥è¯¢: è·å–åˆ° ${random.length} ä¸ªæœªå­¦ä¹ æ±‰å­—`, 
                    'success');
                
                const rankRange = await provider.getCharactersByRankRange(1, 10, learnedChars);
                logResult('simplification-results', 
                    `âœ… æ’åèŒƒå›´æŸ¥è¯¢: è·å–åˆ° ${rankRange.length} ä¸ªæœªå­¦ä¹ æ±‰å­—`, 
                    'success');
                
                // éªŒè¯è¿‡æ»¤é€»è¾‘
                const hasLearned = highFreq.some(char => learnedChars.has(char.char));
                if (!hasLearned) {
                    logResult('simplification-results', 
                        'âœ… è¿‡æ»¤é€»è¾‘æ­£ç¡®: æ‰€æœ‰ç»“æœéƒ½æ˜¯æœªå­¦ä¹ æ±‰å­—', 
                        'success');
                } else {
                    logResult('simplification-results', 
                        'âŒ è¿‡æ»¤é€»è¾‘é”™è¯¯: ç»“æœä¸­åŒ…å«å·²å­¦ä¹ æ±‰å­—', 
                        'error');
                }
                
            } catch (error) {
                logResult('simplification-results', `âŒ ä»£ç ç®€åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æœç´¢åŠŸèƒ½
        async function testSearchFeatures() {
            clearResults('search-results-test');
            
            try {
                const provider = await initializeProvider();
                
                // æµ‹è¯•ç²¾ç¡®æ±‰å­—æœç´¢
                const exactChar = await provider.searchCharacters('ä¸€');
                logResult('search-results-test', 
                    `âœ… ç²¾ç¡®æ±‰å­—æœç´¢: "ä¸€" æ‰¾åˆ° ${exactChar.length} ä¸ªç»“æœ`, 
                    'success');
                
                // æµ‹è¯•ç²¾ç¡®æ‹¼éŸ³æœç´¢
                const exactPinyin = await provider.searchCharacters('yÄ«');
                logResult('search-results-test', 
                    `âœ… ç²¾ç¡®æ‹¼éŸ³æœç´¢: "yÄ«" æ‰¾åˆ° ${exactPinyin.length} ä¸ªç»“æœ`, 
                    'success');
                
                // æµ‹è¯•æ¨¡ç³Šæœç´¢
                const fuzzy = await provider.searchCharacters('zh');
                logResult('search-results-test', 
                    `âœ… æ¨¡ç³Šæœç´¢: "zh" æ‰¾åˆ° ${fuzzy.length} ä¸ªç»“æœ`, 
                    'success');
                
                // æµ‹è¯•ç©ºæŸ¥è¯¢
                const empty = await provider.searchCharacters('');
                logResult('search-results-test', 
                    `âœ… ç©ºæŸ¥è¯¢å¤„ç†: è¿”å› ${empty.length} ä¸ªç»“æœ`, 
                    empty.length === 0 ? 'success' : 'warning');
                
            } catch (error) {
                logResult('search-results-test', `âŒ æœç´¢åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ–°å¢åŠŸèƒ½
        async function testNewFeatures() {
            clearResults('new-features-results');
            
            try {
                const provider = await initializeProvider();
                
                // æµ‹è¯•æ‰¹é‡è·å–æ±‰å­—ä¿¡æ¯
                const batchInfo = await provider.getCharactersInfo(['ä¸€', 'äºŒ', 'ä¸‰', 'ä¸å­˜åœ¨']);
                logResult('new-features-results', 
                    `âœ… æ‰¹é‡è·å–æ±‰å­—ä¿¡æ¯: è¯·æ±‚4ä¸ªï¼Œè·å–åˆ° ${batchInfo.length} ä¸ª`, 
                    'success');
                
                // æµ‹è¯•æ ¹æ®æ‹¼éŸ³è·å–æ±‰å­—
                const pinyinChars = await provider.getCharactersByPinyin('zhÄ«');
                logResult('new-features-results', 
                    `âœ… æ ¹æ®æ‹¼éŸ³è·å–æ±‰å­—: "zhÄ«" å¯¹åº” ${pinyinChars.length} ä¸ªæ±‰å­—`, 
                    'success');
                
                // æµ‹è¯•ç´¢å¼•ç»Ÿè®¡
                const stats = provider.getIndexStatistics();
                logResult('new-features-results', 
                    `âœ… ç´¢å¼•ç»Ÿè®¡: æ±‰å­—ç´¢å¼•${stats.characterMapSize}ä¸ªï¼Œæ‹¼éŸ³ç´¢å¼•${stats.pinyinMapSize}ä¸ª`, 
                    'success');
                
            } catch (error) {
                logResult('new-features-results', `âŒ æ–°å¢åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        async function runPerformanceBenchmark() {
            clearResults('benchmark-results');
            
            try {
                const provider = await initializeProvider();
                logResult('benchmark-results', 'ğŸš€ å¼€å§‹æ€§èƒ½åŸºå‡†æµ‹è¯•...', 'info');
                
                // æµ‹è¯•1: å•æ¬¡æŸ¥è¯¢æ€§èƒ½
                const singleStart = performance.now();
                await provider.getCharacterInfo('ä¸€');
                const singleEnd = performance.now();
                
                logResult('benchmark-results', 
                    `ğŸ“Š å•æ¬¡ç´¢å¼•æŸ¥è¯¢: ${(singleEnd - singleStart).toFixed(3)}ms`, 
                    'info');
                
                // æµ‹è¯•2: æ‰¹é‡æŸ¥è¯¢æ€§èƒ½
                const batchStart = performance.now();
                const testChars = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
                await provider.getCharactersInfo(testChars);
                const batchEnd = performance.now();
                
                logResult('benchmark-results', 
                    `ğŸ“Š æ‰¹é‡æŸ¥è¯¢(10ä¸ª): ${(batchEnd - batchStart).toFixed(3)}ms`, 
                    'info');
                
                // æµ‹è¯•3: æœç´¢æ€§èƒ½
                const searchStart = performance.now();
                await provider.searchCharacters('zh');
                const searchEnd = performance.now();
                
                logResult('benchmark-results', 
                    `ğŸ“Š æ¨¡ç³Šæœç´¢æ€§èƒ½: ${(searchEnd - searchStart).toFixed(3)}ms`, 
                    'info');
                
                logResult('benchmark-results', 'ğŸ‰ æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆï¼', 'success');
                
            } catch (error) {
                logResult('benchmark-results', `âŒ æ€§èƒ½åŸºå‡†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å®æ—¶æœç´¢æ¼”ç¤º
        function setupSearchDemo() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            
            if (searchInput && debouncedSearch) {
                searchInput.addEventListener('input', async (event) => {
                    const query = event.target.value;
                    
                    if (query.trim() === '') {
                        searchResults.innerHTML = 'æœç´¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
                        return;
                    }
                    
                    searchResults.innerHTML = 'ğŸ” æœç´¢ä¸­...';
                    
                    try {
                        const results = await debouncedSearch(query, new Set());
                        
                        if (results.length === 0) {
                            searchResults.innerHTML = 'ğŸ˜” æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ±‰å­—';
                        } else {
                            searchResults.innerHTML = results.slice(0, 10).map(char => 
                                `<div style="margin: 5px 0; padding: 5px; border: 1px solid #eee; border-radius: 3px;">
                                    <strong>${char.char}</strong> - ${char.pinyin} (æ’å: ${char.rank})
                                </div>`
                            ).join('');
                        }
                    } catch (error) {
                        searchResults.innerHTML = `âŒ æœç´¢é”™è¯¯: ${error.message}`;
                    }
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async () => {
            console.log('ğŸš€ CharacterProvider ä¼˜åŒ–æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            try {
                await initializeProvider();
                setupSearchDemo();
                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
    </script>
</body>
</html>
