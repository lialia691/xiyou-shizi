<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataProcessor æ¶æ„ä¼˜åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .architecture-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .dependency-graph {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        .story-preview {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">ğŸ—ï¸ DataProcessor æ¶æ„ä¼˜åŒ–æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>æ¶æ„ä¼˜åŒ–éªŒè¯</h3>
            <button onclick="testArchitectureOptimization()">æµ‹è¯•å•ä¸€èŒè´£åŸåˆ™</button>
            <div id="architecture-results"></div>
        </div>

        <div class="test-section">
            <h3>ä¾èµ–æ³¨å…¥æµ‹è¯•</h3>
            <button onclick="testDependencyInjection()">æµ‹è¯•ä¾èµ–æ³¨å…¥</button>
            <div id="dependency-results"></div>
        </div>

        <div class="test-section">
            <h3>å†…å®¹å¤–éƒ¨åŒ–æµ‹è¯•</h3>
            <button onclick="testContentExternalization()">æµ‹è¯•æ•…äº‹æ¨¡æ¿åŠ è½½</button>
            <div id="content-results"></div>
        </div>

        <div class="test-section">
            <h3>æ¸¸æˆæ•°æ®ç”Ÿæˆæµ‹è¯•</h3>
            <button onclick="testGameDataGeneration()">æµ‹è¯•æ¸¸æˆæ•°æ®ç”Ÿæˆ</button>
            <div id="gamedata-results"></div>
        </div>

        <div class="test-section">
            <h3>å·¥å‚æ¨¡å¼æµ‹è¯•</h3>
            <button onclick="testFactoryPattern()">æµ‹è¯•å·¥å‚æ¨¡å¼</button>
            <div id="factory-results"></div>
        </div>

        <div class="test-section">
            <h3>å®Œæ•´é›†æˆæµ‹è¯•</h3>
            <button onclick="runIntegrationTest()">è¿è¡Œé›†æˆæµ‹è¯•</button>
            <div id="integration-results"></div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="character-provider.js"></script>
    <script src="data-processor.js"></script>

    <script>
        let characterProvider = null;
        let dataProcessor = null;

        // å·¥å…·å‡½æ•°
        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // åˆå§‹åŒ–ä¾èµ–
        async function initializeDependencies() {
            if (!characterProvider) {
                characterProvider = new CharacterProvider();
                await characterProvider.load();
            }
            return characterProvider;
        }

        // æµ‹è¯•æ¶æ„ä¼˜åŒ–
        async function testArchitectureOptimization() {
            clearResults('architecture-results');
            
            try {
                await initializeDependencies();
                
                logResult('architecture-results', 
                    `<div class="architecture-info">
                        <h4>ğŸ—ï¸ æ¶æ„ä¼˜åŒ–éªŒè¯</h4>
                        <p><strong>å•ä¸€èŒè´£åŸåˆ™æ£€æŸ¥:</strong></p>
                        <ul>
                            <li>âœ… DataProcessor ä¸å†ç›´æ¥åŠ è½½æ±‰å­—æ•°æ®</li>
                            <li>âœ… æ•°æ®åŠ è½½èŒè´£å§”æ‰˜ç»™ CharacterProvider</li>
                            <li>âœ… AIå»ºè®®é€»è¾‘å·²ç§»é™¤ï¼ˆåº”å½’å± AIPutiSystemï¼‰</li>
                            <li>âœ… ä¸“æ³¨äºæ¸¸æˆå†…å®¹ç”Ÿæˆå’Œæ•°æ®åŠ å·¥</li>
                        </ul>
                    </div>`, 'info');

                // éªŒè¯ DataProcessor ä¸å†æœ‰æ•°æ®åŠ è½½æ–¹æ³•
                const processor = new DataProcessor(characterProvider);
                const hasLoadMethod = typeof processor.loadChineseWordsData === 'function';
                
                if (!hasLoadMethod) {
                    logResult('architecture-results', 'âœ… ç¡®è®¤ï¼šDataProcessor å·²ç§»é™¤æ•°æ®åŠ è½½æ–¹æ³•', 'success');
                } else {
                    logResult('architecture-results', 'âŒ è­¦å‘Šï¼šDataProcessor ä»åŒ…å«æ•°æ®åŠ è½½æ–¹æ³•', 'warning');
                }

                // éªŒè¯ä¾èµ–æ³¨å…¥
                if (processor.characterProvider === characterProvider) {
                    logResult('architecture-results', 'âœ… ç¡®è®¤ï¼šä¾èµ–æ³¨å…¥æ­£å¸¸å·¥ä½œ', 'success');
                } else {
                    logResult('architecture-results', 'âŒ é”™è¯¯ï¼šä¾èµ–æ³¨å…¥å¤±è´¥', 'error');
                }

            } catch (error) {
                logResult('architecture-results', `âŒ æ¶æ„ä¼˜åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ä¾èµ–æ³¨å…¥
        async function testDependencyInjection() {
            clearResults('dependency-results');
            
            try {
                await initializeDependencies();
                
                logResult('dependency-results', 
                    `<div class="dependency-graph">
                        ä¾èµ–å…³ç³»å›¾:
                        CharacterProvider (æ•°æ®æº)
                            â†“ æ³¨å…¥
                        DataProcessor (æ•°æ®åŠ å·¥)
                            â†“ ç”Ÿæˆ
                        GameData (æ¸¸æˆå†…å®¹)
                    </div>`, 'info');

                // æµ‹è¯•ä¸åŒçš„ CharacterProvider å®ä¾‹
                const customProvider = new CharacterProvider();
                await customProvider.load();
                
                const processor1 = new DataProcessor(characterProvider);
                const processor2 = new DataProcessor(customProvider);
                
                logResult('dependency-results', 'âœ… æˆåŠŸåˆ›å»ºä½¿ç”¨ä¸åŒ CharacterProvider çš„ DataProcessor å®ä¾‹', 'success');
                
                // æµ‹è¯•é…ç½®æ³¨å…¥
                const customProcessor = new DataProcessor(characterProvider, './custom-stories.json');
                logResult('dependency-results', 'âœ… æˆåŠŸæ³¨å…¥è‡ªå®šä¹‰æ•…äº‹æ–‡ä»¶è·¯å¾„', 'success');
                
                // éªŒè¯é…ç½®
                const config = customProcessor.getConfig();
                logResult('dependency-results', 
                    `ğŸ“Š é»˜è®¤é…ç½®: æ¯å…³${config.charactersPerLevel}ä¸ªæ±‰å­—, æœ€å¤š${config.maxLevels}å…³`, 
                    'info');

            } catch (error) {
                logResult('dependency-results', `âŒ ä¾èµ–æ³¨å…¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å†…å®¹å¤–éƒ¨åŒ–
        async function testContentExternalization() {
            clearResults('content-results');
            
            try {
                await initializeDependencies();
                
                logResult('content-results', 'ğŸ”„ æµ‹è¯•å¤–éƒ¨æ•…äº‹æ–‡ä»¶åŠ è½½...', 'info');
                
                const processor = new DataProcessor(characterProvider);
                await processor.initialize();
                
                const storyTemplates = processor.getStoryTemplates();
                
                if (storyTemplates && storyTemplates.length > 0) {
                    logResult('content-results', `âœ… æˆåŠŸåŠ è½½ ${storyTemplates.length} ä¸ªæ•…äº‹æ¨¡æ¿`, 'success');
                    
                    // æ˜¾ç¤ºæ•…äº‹é¢„è§ˆ
                    storyTemplates.slice(0, 3).forEach((story, index) => {
                        logResult('content-results', 
                            `<div class="story-preview">
                                <strong>æ•…äº‹ ${index + 1}: ${story.scene}</strong><br>
                                èƒŒæ™¯: ${story.background}<br>
                                ä¸»é¢˜: ${story.theme || 'æœªè®¾ç½®'}<br>
                                éš¾åº¦: ${story.difficulty || 'æœªè®¾ç½®'}<br>
                                å›¾ç‰‡: ${story.image}
                            </div>`, 'info');
                    });
                    
                    // éªŒè¯æ•…äº‹æ¨¡æ¿å­—æ®µ
                    const firstStory = storyTemplates[0];
                    const requiredFields = ['scene', 'background', 'characters', 'story', 'items', 'image'];
                    const missingFields = requiredFields.filter(field => !firstStory[field]);
                    
                    if (missingFields.length === 0) {
                        logResult('content-results', 'âœ… æ•…äº‹æ¨¡æ¿æ ¼å¼éªŒè¯é€šè¿‡', 'success');
                    } else {
                        logResult('content-results', `âš ï¸ ç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}`, 'warning');
                    }
                    
                } else {
                    logResult('content-results', 'âŒ æ•…äº‹æ¨¡æ¿åŠ è½½å¤±è´¥', 'error');
                }

            } catch (error) {
                logResult('content-results', `âŒ å†…å®¹å¤–éƒ¨åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ¸¸æˆæ•°æ®ç”Ÿæˆ
        async function testGameDataGeneration() {
            clearResults('gamedata-results');
            
            try {
                await initializeDependencies();
                
                logResult('gamedata-results', 'ğŸ® æµ‹è¯•æ¸¸æˆæ•°æ®ç”Ÿæˆ...', 'info');
                
                const processor = new DataProcessor(characterProvider);
                await processor.initialize();
                
                const gameData = processor.getAllLevelsOverview();
                
                if (gameData && gameData.length > 0) {
                    logResult('gamedata-results', `âœ… æˆåŠŸç”Ÿæˆ ${gameData.length} ä¸ªæ¸¸æˆå…³å¡`, 'success');
                    
                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    const stats = processor.getLevelStatistics();
                    logResult('gamedata-results', 
                        `ğŸ“Š å…³å¡ç»Ÿè®¡:
                        <ul>
                            <li>æ€»å…³å¡æ•°: ${stats.totalLevels}</li>
                            <li>æ€»æ±‰å­—æ•°: ${stats.totalCharacters}</li>
                            <li>å¹³å‡æ¯å…³æ±‰å­—æ•°: ${stats.averageCharactersPerLevel}</li>
                            <li>éš¾åº¦åˆ†å¸ƒ: ç®€å•${stats.difficultyDistribution.easy}, æ™®é€š${stats.difficultyDistribution.normal}, å›°éš¾${stats.difficultyDistribution.hard}</li>
                        </ul>`, 'info');
                    
                    // æµ‹è¯•ç‰¹å®šå…³å¡æ•°æ®
                    const level1 = processor.getGameLevelData(1);
                    if (level1) {
                        logResult('gamedata-results', 
                            `ğŸ¯ ç¬¬1å…³è¯¦æƒ…: ${level1.scene}, ${level1.characters.length}ä¸ªæ±‰å­—, éš¾åº¦${level1.difficulty}`, 
                            'info');
                    }
                    
                    // æµ‹è¯•å¹²æ‰°é¡¹ç”Ÿæˆ
                    const distractors = await processor.generateSimilarCharacters('ä¸€', 3);
                    logResult('gamedata-results', 
                        `ğŸ² ä¸º"ä¸€"ç”Ÿæˆçš„å¹²æ‰°é¡¹: ${distractors.join(', ')}`, 
                        'info');
                    
                } else {
                    logResult('gamedata-results', 'âŒ æ¸¸æˆæ•°æ®ç”Ÿæˆå¤±è´¥', 'error');
                }

            } catch (error) {
                logResult('gamedata-results', `âŒ æ¸¸æˆæ•°æ®ç”Ÿæˆæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å·¥å‚æ¨¡å¼
        async function testFactoryPattern() {
            clearResults('factory-results');
            
            try {
                await initializeDependencies();
                
                logResult('factory-results', 'ğŸ­ æµ‹è¯•å·¥å‚æ¨¡å¼...', 'info');
                
                // æµ‹è¯•æ ‡å‡†å·¥å‚æ–¹æ³•
                const standardProcessor = await DataProcessorFactory.createStandard(characterProvider);
                logResult('factory-results', 'âœ… æ ‡å‡†å·¥å‚æ–¹æ³•åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•è‡ªå®šä¹‰å·¥å‚æ–¹æ³•
                const customProcessor = await DataProcessorFactory.createCustom(characterProvider, {
                    gameConfig: {
                        charactersPerLevel: 15,
                        maxLevels: 20,
                        timePerCharacter: 3
                    }
                });
                
                const customConfig = customProcessor.getConfig();
                logResult('factory-results', 
                    `âœ… è‡ªå®šä¹‰å·¥å‚æ–¹æ³•åˆ›å»ºæˆåŠŸ (æ¯å…³${customConfig.charactersPerLevel}å­—)`, 
                    'success');
                
                // æµ‹è¯•æµ‹è¯•å·¥å‚æ–¹æ³•
                const testProcessor = await DataProcessorFactory.createForTesting(characterProvider);
                const testConfig = testProcessor.getConfig();
                logResult('factory-results', 
                    `âœ… æµ‹è¯•å·¥å‚æ–¹æ³•åˆ›å»ºæˆåŠŸ (æ¯å…³${testConfig.charactersPerLevel}å­—, æœ€å¤š${testConfig.maxLevels}å…³)`, 
                    'success');

            } catch (error) {
                logResult('factory-results', `âŒ å·¥å‚æ¨¡å¼æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œé›†æˆæµ‹è¯•
        async function runIntegrationTest() {
            clearResults('integration-results');
            
            try {
                logResult('integration-results', 'ğŸš€ å¼€å§‹å®Œæ•´é›†æˆæµ‹è¯•...', 'info');
                
                // 1. åˆå§‹åŒ–ä¾èµ–
                await initializeDependencies();
                logResult('integration-results', 'âœ… æ­¥éª¤1: CharacterProvider åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // 2. åˆ›å»º DataProcessor
                const processor = await DataProcessorFactory.createStandard(characterProvider);
                logResult('integration-results', 'âœ… æ­¥éª¤2: DataProcessor åˆ›å»ºå®Œæˆ', 'success');
                
                // 3. éªŒè¯æ•°æ®å®Œæ•´æ€§
                const gameData = processor.getAllLevelsOverview();
                const storyTemplates = processor.getStoryTemplates();
                
                if (gameData.length > 0 && storyTemplates.length > 0) {
                    logResult('integration-results', 'âœ… æ­¥éª¤3: æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡', 'success');
                } else {
                    throw new Error('æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥');
                }
                
                // 4. æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
                const highFreqChars = await processor.getHighFrequencyCharacters(1, 5);
                const distractors = await processor.generateSimilarCharacters('ä¸€', 3);
                
                if (highFreqChars.length > 0 && distractors.length > 0) {
                    logResult('integration-results', 'âœ… æ­¥éª¤4: æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    throw new Error('æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•å¤±è´¥');
                }
                
                // 5. æ€§èƒ½æµ‹è¯•
                const startTime = performance.now();
                for (let i = 0; i < 100; i++) {
                    await processor.generateSimilarCharacters('æµ‹', 3);
                }
                const endTime = performance.now();
                
                logResult('integration-results', 
                    `âœ… æ­¥éª¤5: æ€§èƒ½æµ‹è¯•å®Œæˆ (100æ¬¡å¹²æ‰°é¡¹ç”Ÿæˆè€—æ—¶ ${(endTime - startTime).toFixed(2)}ms)`, 
                    'success');
                
                logResult('integration-results', 'ğŸ‰ é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼æ¶æ„ä¼˜åŒ–æˆåŠŸï¼', 'success');

            } catch (error) {
                logResult('integration-results', `âŒ é›†æˆæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            console.log('ğŸ—ï¸ DataProcessor æ¶æ„ä¼˜åŒ–æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            try {
                await initializeDependencies();
                console.log('âœ… ä¾èµ–åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ ä¾èµ–åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
    </script>
</body>
</html>
